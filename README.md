# ๐ Bitrix Docker Environment

Production-ready Docker ะพะบััะถะตะฝะธะต ะดะปั 1ะก-ะะธััะธะบั: ะฃะฟัะฐะฒะปะตะฝะธะต ัะฐะนัะพะผ

[![GitHub](https://img.shields.io/badge/GitHub-Repository-blue)](https://github.com/vbcherepanov/b-docker)

## โจ ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ

### ๐ฏ ะะดะธะฝัะน ะบะพะฝัะตะนะฝะตั Bitrix
- **Supervisor** ัะฟัะฐะฒะปัะตั ะฒัะตะผะธ ะฟัะพัะตััะฐะผะธ
- **PHP-FPM** ะดะปั ะพะฑัะฐะฑะพัะบะธ ะฒะตะฑ-ะทะฐะฟัะพัะพะฒ
- **Cron** ะดะปั ะฐะณะตะฝัะพะฒ ะะธััะธะบั
- **PHP-CLI** ะดะปั ะบะพะฝัะพะปัะฝัั ะบะพะผะฐะฝะด
- ะัะต ะฒ ะพะดะฝะพะผ ะบะพะฝัะตะนะฝะตัะต ะดะปั ัะฟัะพัะตะฝะฝะพะณะพ ัะฟัะฐะฒะปะตะฝะธั

### ๐๏ธ ะััะธัะตะบัััะฐ
- **PHP 7.4 / 8.3 / 8.4** โ ะฒัะฑะพั ัะตัะตะท `PHP_VERSION` ะฒ `.env`
- **MySQL 8.0 / MariaDB 10.11** โ ะฒัะฑะพั ัะตัะตะท `MYSQL_IMAGE` ะฒ `.env`
- **Redis** ะดะปั ะบััะธัะพะฒะฐะฝะธั ะดะฐะฝะฝัั ะธ ัะตััะธะน
- **Memcached** ะดะปั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะณะพ ะบััะฐ
- **Nginx** ั ะพะฟัะธะผะธะทะฐัะธะตะน ะฟะพะด ะะธััะธะบั

### ๐ ะะพะฝะธัะพัะธะฝะณ
- **Grafana** - ะฒะธะทัะฐะปะธะทะฐัะธั ะผะตััะธะบ ะธ ะปะพะณะพะฒ
- **Prometheus** - ัะฑะพั ะผะตััะธะบ
- **Loki** - ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต (1 ะณะพะด retention)
- **Promtail** - ัะฑะพั ะปะพะณะพะฒ ะธะท ะฒัะตั ะบะพะฝัะตะนะฝะตัะพะฒ
- **Logrotate** - ัะพัะฐัะธั ัะฐะนะปะพะฒ ะปะพะณะพะฒ (7 ะดะฝะตะน)

### ๐ก๏ธ ะะตะทะพะฟะฐัะฝะพััั
- **Security Scanning** - OWASP ZAP, Nikto, TestSSL, Trivy
- **Fail2ban** - ะทะฐัะธัะฐ ะพั ะฑััััะพััะฐ
- **ModSecurity WAF** - ะฒะตะฑ-ัะฐะนัะฒะพะป
- **Rate limiting** - ะทะฐัะธัะฐ ะพั DDoS
- **Security headers** - XSS, CSRF ะทะฐัะธัะฐ
- **Non-root execution** - ะบะพะฝัะตะนะฝะตัั ัะฐะฑะพัะฐัั ะฑะตะท root
- **PHP hardening** - ะพัะบะปััะตะฝั ะพะฟะฐัะฝัะต ััะฝะบัะธะธ

### ๐ ะะบััะถะตะฝะธั
ะะพัะพะฒัะต ะบะพะฝัะธะณััะฐัะธะธ ะดะปั:
- **local** - ะปะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ
- **dev** - ัะฐะทัะฐะฑะพััะตัะบะธะน ัะตัะฒะตั
- **test** - ัะตััะธัะพะฒะฐะฝะธะต
- **prod** - production ั ะผะฐะบัะธะผะฐะปัะฝะพะน ะพะฟัะธะผะธะทะฐัะธะตะน

## ๐๏ธ ะััะธัะตะบัััะฐ ัะธััะตะผั

```
Internet โ Nginx (80/443)
              โ
     Bitrix Container (ะตะดะธะฝัะน ะบะพะฝัะตะนะฝะตั)
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ      Supervisor          โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ PHP-FPM | Cron | CLI     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
     MySQL | Redis | Memcached
              โ
     Grafana โ Loki โ Promtail
```

## ๐ป ะขัะตะฑะพะฒะฐะฝะธั

- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **RAM**: ะผะธะฝะธะผัะผ 4GB, ัะตะบะพะผะตะฝะดัะตััั 8GB+
- **CPU**: ะผะธะฝะธะผัะผ 2 cores
- **Disk**: 20GB ัะฒะพะฑะพะดะฝะพะณะพ ะผะตััะฐ

### ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะฟะปะฐััะพัะผั
- โ Linux (Ubuntu, Debian, CentOS, Fedora)
- โ macOS (Intel ะธ Apple Silicon)
- โ Windows 10/11 (ั WSL 2)

## ๐ ะัััััะน ััะฐัั

### 1. ะะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั

```bash
git clone <your-repo-url>
cd b-docker
```

### 2. ะะฐัััะพะนะบะฐ ะพะบััะถะตะฝะธั

#### ะะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ:
```bash
cp .env.local.bitrix .env
nano .env  # ะะฐัััะพะนัะต DOMAIN ะธ ะดััะณะธะต ะฟะฐัะฐะผะตััั
```

#### ะะปั production:
```bash
cp .env.prod.bitrix .env
nano .env  # ะะะฏะะะขะะะฌะะ ัะผะตะฝะธัะต ะฒัะต ะฟะฐัะพะปะธ!
```

### 3. ะะฒัะพะผะฐัะธัะตัะบะฐั ะฝะฐัััะพะนะบะฐ

```bash
# ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั CPU, RAM ะธ ะณะตะฝะตัะธััะตั ะพะฟัะธะผะฐะปัะฝัะต ะบะพะฝัะธะณะธ
./auto-setup-bitrix.sh local

# ะะปั production
./auto-setup-bitrix.sh prod
```

### 4. ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน

```bash
mkdir -p www/upload www/local www/bitrix/cache
mkdir -p volume/logs volume/mysql/dump
mkdir -p ssl backups
```

### 5. ะะฐะฟััะบ

```bash
# ะะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ
docker compose -f docker-compose.bitrix.yml --profile local up -d

# Production ัะพ ะฒัะตะผะธ ะฟัะพัะธะปัะผะธ
docker compose -f docker-compose.bitrix.yml \
  --profile prod \
  --profile monitoring \
  --profile security \
  up -d
```

### 6. ะฃััะฐะฝะพะฒะบะฐ ะะธััะธะบั

ะัะบัะพะนัะต ะฒ ะฑัะฐัะทะตัะต: `http://your-domain.local`

ะะฐัะฐะผะตััั ะฟะพะดะบะปััะตะฝะธั ะบ ะะ:
- **ะกะตัะฒะตั**: `mysql`
- **ะะฐะทะฐ ะดะฐะฝะฝัั**: ะทะฝะฐัะตะฝะธะต ะธะท `.env` (`DB_NAME`)
- **ะะพะปัะทะพะฒะฐัะตะปั**: ะทะฝะฐัะตะฝะธะต ะธะท `.env` (`DB_USERNAME`)
- **ะะฐัะพะปั**: ะทะฝะฐัะตะฝะธะต ะธะท `.env` (`DB_PASSWORD`)

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
b-docker/
โโโ docker-compose.bitrix.yml    # ะัะฝะพะฒะฝะพะน compose ัะฐะนะป
โโโ docker-compose.security.yml  # Security scanners
โโโ auto-setup-bitrix.sh         # ะะฒัะพะฝะฐัััะพะนะบะฐ ะฟะพะด ะถะตะปะตะทะพ
โโโ security-scan.sh             # ะกะบะฐะฝะธัะพะฒะฐะฝะธะต ะฑะตะทะพะฟะฐัะฝะพััะธ
โโโ Makefile                     # ะะพะผะฐะฝะดั ัะฟัะฐะฒะปะตะฝะธั
โ
โโโ .env.local.bitrix           # ะะพะฝัะธะณ ะดะปั local
โโโ .env.dev.bitrix             # ะะพะฝัะธะณ ะดะปั dev
โโโ .env.test.bitrix            # ะะพะฝัะธะณ ะดะปั test
โโโ .env.prod.bitrix            # ะะพะฝัะธะณ ะดะปั production
โโโ .env                         # ะะบัะธะฒะฝัะน ะบะพะฝัะธะณ (ัะพะทะดะฐะตััั ะฒะฐะผะธ)
โ
โโโ SECURITY.md                 # ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะฟะพ ะฑะตะทะพะฟะฐัะฝะพััะธ
โโโ SECURITY-QUICK-START.md     # ะัััััะน ััะฐัั ะฑะตะทะพะฟะฐัะฝะพััะธ
โ
โโโ docker/
โ   โโโ php/
โ   โ   โโโ base/               # ะะฐะทะพะฒัะต ะพะฑัะฐะทั PHP
โ   โ   โโโ bitrix/             # ะะดะธะฝัะน Bitrix ะบะพะฝัะตะนะฝะตั
โ   โ       โโโ Dockerfile
โ   โ       โโโ supervisord.conf
โ   โ       โโโ docker-entrypoint.sh
โ   โ       โโโ healthcheck.sh
โ   โโโ nginx/
โ   โโโ mysql/
โ   โโโ fail2ban/
โ   โโโ modsecurity/
โ
โโโ security-scripts/           # ะกะบัะธะฟัั ะฟัะพะฒะตัะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ
โ   โโโ bitrix-security-check.sh
โ
โโโ security-reports/           # ะััะตัั ัะบะฐะฝะธัะพะฒะฐะฝะธั (ะฒ .gitignore)
โ
โโโ config/
โ   โโโ cron/crontab            # ะะธััะธะบั cron ะทะฐะดะฐัะธ
โ   โโโ grafana/dashboards/     # ะะพัะพะฒัะต ะดะฐัะฑะพัะดั
โ   โโโ loki/                   # Loki ะบะพะฝัะธะณััะฐัะธั
โ   โโโ mysql/                  # MySQL ะบะพะฝัะธะณะธ ะดะปั ะพะบััะถะตะฝะธะน
โ   โโโ nginx/                  # Nginx ะบะพะฝัะธะณััะฐัะธั
โ   โโโ prometheus/rules/       # Alerting ะฟัะฐะฒะธะปะฐ
โ   โโโ promtail/               # Promtail ะบะพะฝัะธะณััะฐัะธั
โ   โโโ redis/                  # Redis ะบะพะฝัะธะณััะฐัะธั
โ   โโโ logrotate/              # ะะพัะฐัะธั ะปะพะณะพะฒ
โ   โโโ supervisor/conf/        # Supervisor ะฟัะพะณัะฐะผะผั
โ
โโโ www/                        # ะะพะด ะะธััะธะบั
โ   โโโ upload/                 # ะคะฐะนะปั ะทะฐะณััะทะพะบ (volume)
โ   โโโ local/                  # ะะพะบะฐะปัะฝัะต ะผะพะดัะปะธ (volume)
โ   โโโ bitrix/
โ   โ   โโโ cache/             # ะัั ะะธััะธะบั (volume)
โ   โโโ index.php
โ
โโโ volume/                     # Persistent data
โ   โโโ logs/                  # ะะพะณะธ ะฒัะตั ัะตัะฒะธัะพะฒ
โ   โ   โโโ nginx/
โ   โ   โโโ php-fpm/
โ   โ   โโโ mysql/
โ   โ   โโโ cron/
โ   โ   โโโ supervisor/
โ   โ   โโโ bitrix/
โ   โโโ mysql/
โ   โ   โโโ dump/              # ะะธัะตะบัะพัะธั ะดะปั ะดะฐะผะฟะพะฒ
โ   โโโ grafana/
โ
โโโ backups/                    # ะัะบะฐะฟั
โโโ ssl/                        # SSL ัะตััะธัะธะบะฐัั
```

## โ๏ธ ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### Bitrix Container
ะะดะธะฝัะน ะบะพะฝัะตะนะฝะตั ั Supervisor ัะฟัะฐะฒะปัััะธะผ ะฒัะตะผะธ ะฟัะพัะตััะฐะผะธ:
- **PHP-FPM** (ะฟะพัั 9000) - ะพะฑัะฐะฑะพัะบะฐ ะฒะตะฑ-ะทะฐะฟัะพัะพะฒ
- **Cron** - ะฒัะฟะพะปะฝะตะฝะธะต ะฐะณะตะฝัะพะฒ ะะธััะธะบั ะบะฐะถะดัะต 5 ะผะธะฝัั
- **PHP-CLI** - ะบะพะฝัะพะปัะฝัะต ะบะพะผะฐะฝะดั

### ะะฐะทะฐ ะดะฐะฝะฝัั
- **MySQL 8.0** โ ะฟะพะปะฝะพััะฝะบัะธะพะฝะฐะปัะฝะฐั ะฒะตััะธั (ัะตะบะพะผะตะฝะดัะตััั)
- **MariaDB 10.11** โ ะดะปั ัะตัะฒะตัะพะฒ ั ะพะณัะฐะฝะธัะตะฝะฝะพะน RAM
- ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฝัะต ะบะพะฝัะธะณััะฐัะธะธ ะดะปั ะบะฐะถะดะพะณะพ ะพะบััะถะตะฝะธั
- ะะพะณะธ slow queries ะธ errors ะธะดัั ะฒ Grafana

ะัะฑะพั ะฒ `.env`:
```bash
MYSQL_IMAGE=mysql:8.0       # MySQL 8 (default)
MYSQL_IMAGE=mariadb:10.11   # MariaDB (low RAM)
```

### ะััะธัะพะฒะฐะฝะธะต
- **Redis** - ะบัั ะดะฐะฝะฝัั, ัะตััะธะธ
- **Memcached** - ะดะพะฟะพะปะฝะธัะตะปัะฝะพะต ะบััะธัะพะฒะฐะฝะธะต
- **OPcache** - ะบััะธัะพะฒะฐะฝะธะต PHP ะบะพะดะฐ

### ะะพะฝะธัะพัะธะฝะณ
- **Grafana** (ะฟะพัั 3000) - ะฒะธะทัะฐะปะธะทะฐัะธั
- **Prometheus** (ะฟะพัั 9090) - ะผะตััะธะบะธ
- **Loki** (ะฟะพัั 3100) - ะปะพะณะธ ั 1 ะณะพะด retention
- **Promtail** - ัะฑะพั ะปะพะณะพะฒ

### ะะตะทะพะฟะฐัะฝะพััั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
- **Fail2ban** - ะทะฐัะธัะฐ ะพั ะฐัะฐะบ
- **ModSecurity** - WAF ั OWASP rules
- **Rate limiting** ะฒ Nginx
- **Security headers**

## ๐ฎ ะฃะฟัะฐะฒะปะตะฝะธะต

### Docker Compose ะบะพะผะฐะฝะดั

```bash
# ะะฐะฟััะบ
docker compose -f docker-compose.bitrix.yml up -d

# ะััะฐะฝะพะฒะบะฐ
docker compose -f docker-compose.bitrix.yml down

# ะะตัะตะทะฐะฟััะบ
docker compose -f docker-compose.bitrix.yml restart bitrix

# ะะพะณะธ
docker compose -f docker-compose.bitrix.yml logs -f bitrix

# ะัะพะด ะฒ ะบะพะฝัะตะนะฝะตั
docker compose -f docker-compose.bitrix.yml exec bitrix bash

# ะกัะฐััั ะฟัะพัะตััะพะฒ Supervisor
docker compose -f docker-compose.bitrix.yml exec bitrix supervisorctl status
```

### Makefile ะบะพะผะฐะฝะดั

```bash
# ะะฝะธัะธะฐะปะธะทะฐัะธั
make init-local              # ะะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ
make init-prod               # ะะปั production

# ะฃะฟัะฐะฒะปะตะฝะธะต
make up                      # ะะฐะฟััะบ
make down                    # ะััะฐะฝะพะฒะบะฐ
make restart                 # ะะตัะตะทะฐะฟััะบ
make logs                    # ะะพะณะธ

# ะัะบะฐะฟั
make backup-db               # ะัะบะฐะฟ ะฑะฐะทั ะดะฐะฝะฝัั
make backup-files            # ะัะบะฐะฟ ัะฐะนะปะพะฒ
make backup-full             # ะะพะปะฝัะน ะฑัะบะฐะฟ

# ะัะธััะบะฐ
make clean-cache             # ะัะธััะบะฐ ะบััะฐ ะะธััะธะบั
make clean-logs              # ะัะธััะบะฐ ะปะพะณะพะฒ
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต

### Grafana

**URL**: http://localhost:3000
**ะะพะณะธะฝ**: admin / ะฟะฐัะพะปั ะธะท `.env`

**ะะฐัะฑะพัะดั:**
- Security Dashboard - ะผะพะฝะธัะพัะธะฝะณ ะฑะตะทะพะฟะฐัะฝะพััะธ ะธ ะฐัะฐะบ
- Nginx Security Analysis - ะฐะฝะฐะปะธะท ััะฐัะธะบะฐ
- System Metrics - CPU, RAM, Disk
- MySQL Metrics - ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะะ
- Redis Metrics - ะบัั ััะฐัะธััะธะบะฐ

### ะะพะณะธ

ะัะต ะปะพะณะธ ัะพะฑะธัะฐัััั ะฒ ะดะฒัั ะผะตััะฐั:

1. **ะคะฐะนะปั** (retention 7 ะดะฝะตะน):
   ```
   ./volume/logs/
   โโโ nginx/          - access.log, error.log
   โโโ php-fpm/        - error.log, slow.log
   โโโ mysql/          - error.log, slow.log
   โโโ cron/           - cron.log (ะฐะณะตะฝัั ะะธััะธะบั)
   โโโ supervisor/     - supervisord.log
   โโโ bitrix/         - ะฑะธััะธะบั ะปะพะณะธ
   ```

2. **Loki** (retention 1 ะณะพะด):
   - ะัะต ะปะพะณะธ ะธะท ะบะพะฝัะตะนะฝะตัะพะฒ
   - ะะพะธัะบ ัะตัะตะท Grafana Explore
   - ะะปะตััั ะฒ Prometheus

### ะะพะธัะบ ะฒ ะปะพะณะฐั (Grafana โ Explore โ Loki)

```logql
# ะัะธะฑะบะธ PHP
{container_name="bitrix"} |= "error"

# ะะตะดะปะตะฝะฝัะต ะทะฐะฟัะพัั MySQL
{job="mysql"} |= "slow"

# ะะณะตะฝัั ะะธััะธะบั (cron)
{job="cron"}

# ะะปะพะบะธัะพะฒะบะธ Fail2ban
{job="fail2ban"} |= "Ban"
```

## ๐ก๏ธ ะะตะทะพะฟะฐัะฝะพััั

### Security Headers (ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒ Nginx)
- `X-Frame-Options: SAMEORIGIN`
- `X-Content-Type-Options: nosniff`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: no-referrer-when-downgrade`

### Rate Limiting
- Login/Admin: 5 ะทะฐะฟัะพัะพะฒ/ะผะธะฝััั
- API: 10 ะทะฐะฟัะพัะพะฒ/ัะตะบัะฝะดั
- Static: 30 ะทะฐะฟัะพัะพะฒ/ัะตะบัะฝะดั
- General: 2 ะทะฐะฟัะพัะฐ/ัะตะบัะฝะดั

### SSL/TLS

**ะะฒัะพะผะฐัะธัะตัะบะธะต ัะตััะธัะธะบะฐัั (Let's Encrypt):**
```bash
# ะ .env ัััะฐะฝะพะฒะธัะต:
SSL=free
EMAIL=your@email.com
```

**ะกะพะฑััะฒะตะฝะฝัะต ัะตััะธัะธะบะฐัั:**
```bash
# ะ .env ัััะฐะฝะพะฒะธัะต:
SSL=self

# ะะพะผะตััะธัะต ัะตััะธัะธะบะฐัั ะฒ:
config/nginx/ssl/${DOMAIN}/fullchain.pem
config/nginx/ssl/${DOMAIN}/privkey.pem
```

### Fail2ban (ะพะฟัะธะพะฝะฐะปัะฝะพ)

```bash
# ะะฐะฟััะบ
docker compose --profile security up -d

# ะกัะฐััั
docker compose exec fail2ban fail2ban-client status

# ะะฐะฑะปะพะบะธัะพะฒะฐะฝะฝัะต IP
docker compose exec fail2ban fail2ban-client status nginx-brute

# ะะฐะทะฑะปะพะบะธัะพะฒะฐัั IP
docker compose exec fail2ban fail2ban-client unban 192.168.1.100
```

### ๐ ะัะพะฒะตัะบะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ

ะัััะพะตะฝะฝะฐั ัะธััะตะผะฐ ัะบะฐะฝะธัะพะฒะฐะฝะธั ะฑะตะทะพะฟะฐัะฝะพััะธ ั ะฟัะพัะตััะธะพะฝะฐะปัะฝัะผะธ ะธะฝััััะผะตะฝัะฐะผะธ:

#### ะััััะฐั ะฟัะพะฒะตัะบะฐ (5-10 ะผะธะฝัั)

```bash
./security-scan.sh quick
```

**ะัะพะฒะตััะตั:**
- โ OWASP Top 10 ััะทะฒะธะผะพััะธ (XSS, SQL injection, CSRF)
- โ ะะพะฝัะธะณััะฐัะธั ะฒะตะฑ-ัะตัะฒะตัะฐ (Nikto)
- โ ะัะฐะฒะฐ ะดะพัััะฟะฐ ะบ ัะฐะนะปะฐะผ Bitrix
- โ PHP ัะฐะนะปั ะฒ upload ะดะธัะตะบัะพัะธะธ
- โ ะะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะธ ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั
- โ ะะฐัััะพะนะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ PHP

#### ะะพะปะฝะฐั ะฟัะพะฒะตัะบะฐ (30-60 ะผะธะฝัั)

```bash
./security-scan.sh full
```

**ะะพะฟะพะปะฝะธัะตะปัะฝะพ:**
- โ ะะปัะฑะพะบะพะต ัะบะฐะฝะธัะพะฒะฐะฝะธะต OWASP ZAP
- โ SSL/TLS ะบะพะฝัะธะณััะฐัะธั (TestSSL)
- โ CVE ััะทะฒะธะผะพััะธ ะฒ Docker ะพะฑัะฐะทะฐั (Trivy)
- โ Composer ะทะฐะฒะธัะธะผะพััะธ

#### ะัะพัะผะพัั ัะตะทัะปััะฐัะพะฒ

```bash
# ะกะฒะพะดะฝัะน HTML ะพััะตั
open security-reports/summary-*.html

# Bitrix ัะฟะตัะธัะธัะฝัะต ะฟัะพะฒะตัะบะธ
cat security-reports/bitrix-security.txt

# OWASP ZAP ะพััะตั
open security-reports/zap-baseline-report.html
```

**ะะพะดัะพะฑะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั:**
- [SECURITY-QUICK-START.md](SECURITY-QUICK-START.md) - ะฑัััััะน ััะฐัั
- [SECURITY.md](SECURITY.md) - ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั

#### ะะฐัััะพะนะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ PHP

ะะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธะผะตะฝะตะฝั ัะปะตะดัััะธะต ะฝะฐัััะพะนะบะธ:

```ini
# php.ini
allow_url_fopen = Off              # ะัะบะปััะตะฝั URL wrappers
request_order = "GP"               # ะขะพะปัะบะพ GET ะธ POST ะฒ $_REQUEST
session.cookie_secure = On         # Secure cookie ัะพะปัะบะพ ะดะปั HTTPS
session.cookie_httponly = On       # ะะฐัะธัะฐ ะพั XSS
session.cookie_samesite = "Lax"    # ะะฐัะธัะฐ ะพั CSRF
```

#### ะัะฐะฒะฐ ะดะพัััะฟะฐ ะบ ัะฐะนะปะฐะผ

```bash
# ะะธัะตะบัะพัะธะธ Bitrix
/bitrix/cache     - 775 (ะฒะปะฐะดะตะปะตั + ะณััะฟะฟะฐ: rw, ะพััะฐะปัะฝัะต: r)
/upload           - 775 (ะฒะปะฐะดะตะปะตั + ะณััะฟะฟะฐ: rw, ะพััะฐะปัะฝัะต: r)
/var/lib/php/sessions - 770 (ัะพะปัะบะพ ะฒะปะฐะดะตะปะตั + ะณััะฟะฟะฐ)

# ะัะธัะธัะฝัะต ัะฐะนะปั (ัะตะบะพะผะตะฝะดัะตััั)
.settings.php     - 600 ะธะปะธ 640
dbconn.php        - 600 ะธะปะธ 640
```

**ะะะะะ:** ะัะต ะพััะตัั ะฑะตะทะพะฟะฐัะฝะพััะธ ัะพะดะตัะถะฐั ััะฒััะฒะธัะตะปัะฝัั ะธะฝัะพัะผะฐัะธั ะธ ะดะพะฑะฐะฒะปะตะฝั ะฒ `.gitignore`.

## โก ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### Auto-setup ัะบัะธะฟั

ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั ะถะตะปะตะทะพ ะธ ะณะตะฝะตัะธััะตั ะพะฟัะธะผะฐะปัะฝัะต ะบะพะฝัะธะณััะฐัะธะธ:

```bash
./auto-setup-bitrix.sh local
./auto-setup-bitrix.sh prod
```

**ะงัะพ ะฝะฐัััะฐะธะฒะฐะตััั:**
- MySQL buffer pool (60% RAM)
- MySQL connections (50 ะฝะฐ CPU core)
- PHP-FPM workers (5 ะฝะฐ CPU core)
- Redis maxmemory (25% RAM)
- Nginx worker processes (ะฟะพ ะบะพะปะธัะตััะฒั CPU)

### ะะฟัะธะผะธะทะฐัะธั ะะธััะธะบั

1. **ะะพะผะฟะพะทะธัะฝัะน ะบัั**:
   - ะะดะผะธะฝะบะฐ โ ะะฐัััะพะนะบะธ โ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
   - ะะบะปััะธัั "ะะพะผะฟะพะทะธัะฝัะน ัะฐะนั"

2. **ะัะฟะพะปัะทะพะฒะฐะฝะธะต Redis**:
   - ะฃะถะต ะฝะฐัััะพะตะฝ ะดะปั ะบััะฐ ะธ ัะตััะธะน
   - ะัะพะฒะตัะธัั ะฒ .settings.php

3. **OPcache**:
   - ะะบะปััะตะฝ ะฒ prod
   - ะัะบะปััะตะฝ ะฒ local ะดะปั ะฐะบััะฐะปัะฝะพะณะพ ะบะพะดะฐ

## ๐พ ะัะบะฐะฟั

### ะะฒัะพะผะฐัะธัะตัะบะธะต ะฑัะบะฐะฟั

ะะฐัััะฐะธะฒะฐัััั ะฒ `.env`:
```bash
BACKUP_SCHEDULE_DB=0 2 * * *      # ะะ ะฒ 2:00 ะบะฐะถะดัะน ะดะตะฝั
BACKUP_SCHEDULE_FILES=0 3 * * *   # ะคะฐะนะปั ะฒ 3:00 ะบะฐะถะดัะน ะดะตะฝั
BACKUP_RETENTION_DAYS=30          # ะฅัะฐะฝะธัั 30 ะดะฝะตะน
```

### ะััะฝัะต ะฑัะบะฐะฟั

```bash
# ะะฐะทะฐ ะดะฐะฝะฝัั
docker compose exec mysql mysqldump -ubitrix -p${DB_PASSWORD} ${DB_NAME} \
  | gzip > ./backups/db_$(date +%Y%m%d_%H%M%S).sql.gz

# ะคะฐะนะปั
tar -czf ./backups/files_$(date +%Y%m%d_%H%M%S).tar.gz \
  ./www/upload ./www/local

# ะะปะธ ัะตัะตะท Makefile
make backup-db
make backup-files
make backup-full
```

### ะะพัััะฐะฝะพะฒะปะตะฝะธะต

```bash
# ะะฐะทะฐ ะดะฐะฝะฝัั
gunzip < ./backups/db_20250101_020000.sql.gz | \
  docker compose exec -T mysql mysql -ubitrix -p${DB_PASSWORD} ${DB_NAME}

# ะคะฐะนะปั
tar -xzf ./backups/files_20250101_030000.tar.gz -C ./www/
```

## ๐ง Troubleshooting

### 502 Bad Gateway

```bash
# ะัะพะฒะตัััะต PHP-FPM
docker compose exec bitrix supervisorctl status php-fpm

# ะะตัะตะทะฐะฟัััะธัะต
docker compose exec bitrix supervisorctl restart php-fpm

# ะะพะณะธ
docker compose logs bitrix
```

### ะะตั ะฟะพะดะบะปััะตะฝะธั ะบ ะะ

```bash
# ะัะพะฒะตัััะต MySQL
docker compose exec mysql mysqladmin ping

# ะัะพะฒะตัััะต ะฟะฐัะพะปั ะฒ .env
grep DB_PASSWORD .env

# ะัะพะฒะตัััะต .settings.php
cat www/bitrix/.settings.php | grep -A 5 connections
```

### Redis: NOAUTH Authentication required

Bitrix ะฒัะดะฐะตั ะพัะธะฑะบั `[RedisException] NOAUTH Authentication required`:

**ะัะธัะธะฝะฐ:** ะะฐัะพะปั Redis ะทะฐะดะฐะฝ ะฒ `.env`, ะฝะพ Bitrix ะฝะต ะทะฝะฐะตั ะพ ะฝัะผ.

**ะะตัะตะฝะธะต:**
```bash
# 1. ะกะบะพะฟะธััะนัะต ะฟัะธะผะตั ะบะพะฝัะธะณััะฐัะธะธ
cp config/bitrix/.settings.php.example www/bitrix/.settings.php

# 2. ะะปะธ ะดะพะฑะฐะฒััะต password ะฒ ัััะตััะฒัััะธะน .settings.php:
```

ะ ัะฐะนะปะต `www/bitrix/.settings.php` ะฝะฐะนะดะธัะต ัะตะบัะธั `cache` ะธ ะดะพะฑะฐะฒััะต `password`:

```php
'cache' => [
    'value' => [
        'type' => [
            'class_name' => '\\Bitrix\\Main\\Data\\CacheEngineRedis',
            'extension' => 'redis',
        ],
        'redis' => [
            'host' => getenv('REDIS_HOST') ?: 'redis',
            'port' => 6379,
            'password' => getenv('REDIS_PASSWORD') ?: '',  // <-- ะะะะะะะขะฌ ะญะขะฃ ะกะขะะะะฃ
        ],
    ],
],

// ะขะฐะบะถะต ะดะปั ัะตััะธะน:
'session' => [
    'value' => [
        'mode' => 'default',
        'handlers' => [
            'general' => [
                'type' => 'redis',
                'host' => getenv('REDIS_HOST') ?: 'redis',
                'port' => 6379,
                'password' => getenv('REDIS_PASSWORD') ?: '',  // <-- ะะะะะะะขะฌ ะญะขะฃ ะกะขะะะะฃ
            ],
        ],
    ],
],
```

**ะัะพะฒะตัะบะฐ:**
```bash
# ะัะพะฒะตัััะต ััะพ Redis ััะตะฑัะตั ะฟะฐัะพะปั
docker compose exec redis redis-cli PING
# ะะพะปะถะฝะพ ะฑััั: (error) NOAUTH Authentication required

# ะก ะฟะฐัะพะปะตะผ
docker compose exec redis redis-cli -a "${REDIS_PASSWORD}" PING
# ะะพะปะถะฝะพ ะฑััั: PONG
```

### ะัะฐะฒะฐ ะดะพัััะฟะฐ ะฝะฐ ัะฐะนะปั

```bash
# ะฃะทะฝะฐะนัะต ัะฒะพะน UID/GID
id -u  # UID
id -g  # GID

# ะฃััะฐะฝะพะฒะธัะต ะฒ .env
UID=1000
GID=1000

# ะะตัะตัะพะทะดะฐะนัะต ะบะพะฝัะตะนะฝะตัั
docker compose down && docker compose up -d --build

# ะัะฟัะฐะฒััะต ะฟัะฐะฒะฐ
sudo chown -R 1000:1000 ./www/upload
sudo chmod -R 777 ./www/upload ./www/bitrix/cache
```

### ะะตะดะปะตะฝะฝะฐั ัะฐะฑะพัะฐ

**ะงะตะบะปะธัั:**
1. โ OPcache ะฒะบะปััะตะฝ (prod)
2. โ MySQL buffer pool ะฝะฐัััะพะตะฝ
3. โ ะะพะผะฟะพะทะธัะฝัะน ะบัั ะะธััะธะบัะฐ ะฒะบะปััะตะฝ
4. โ Redis ัะฐะฑะพัะฐะตั

```bash
# ะะตะดะปะตะฝะฝัะต ะทะฐะฟัะพัั MySQL
docker compose exec mysql tail -f /var/log/mysql/slow.log

# ะะตะดะปะตะฝะฝัะต ะทะฐะฟัะพัั PHP
docker compose logs bitrix | grep slow
```

## โ FAQ

### ะะฐะบะฐั ะฒะตััะธั PHP?
**PHP 8.3** ะฟะพ ัะผะพะปัะฐะฝะธั. ะะพัััะฟะฝัะต ะฒะตััะธะธ:
- **PHP 7.4** โ ะดะปั ััะฐััั ะผะพะดัะปะตะน ะธ ะปะตะณะฐัะธ-ะฟัะพะตะบัะพะฒ
- **PHP 8.3** โ ัะตะบะพะผะตะฝะดัะตะผะฐั ััะฐะฑะธะปัะฝะฐั ะฒะตััะธั
- **PHP 8.4** โ ัะบัะฟะตัะธะผะตะฝัะฐะปัะฝะฐั (Bitrix ะพัะธัะธะฐะปัะฝะพ ะฟะพะดะดะตัะถะธะฒะฐะตั ะดะพ 8.3)

### ะะฐะบ ะฟะตัะตะบะปััะธัั PHP ะฒะตััะธั?
```bash
# ะ .env ะธะทะผะตะฝะธัะต:
PHP_VERSION=8.4    # ะธะปะธ 8.3, 7.4

# ะะตัะตัะพะฑะตัะธัะต ะฑะฐะทะพะฒัะต ะพะฑัะฐะทั ะธ ะบะพะฝัะตะนะฝะตัั
make build-base
make restart-local
```

### MySQL ะธะปะธ MariaDB?
- **MySQL 8.0** โ ัะตะบะพะผะตะฝะดัะตััั ะดะปั ัะตัะฒะตัะพะฒ ั 4GB+ RAM
- **MariaDB 10.11** โ ะดะปั ัะตัะฒะตัะพะฒ ั ะพะณัะฐะฝะธัะตะฝะฝะพะน RAM (2-4GB)

```bash
# ะ .env ะธะทะผะตะฝะธัะต:
MYSQL_IMAGE=mysql:8.0       # MySQL 8
MYSQL_IMAGE=mariadb:10.11   # MariaDB
```

### ะะฐะฑะพัะฐะตั ะฝะฐ macOS Apple Silicon?
**ะะฐ!** ะัะต ะพะฑัะฐะทั ะฟะพะดะดะตัะถะธะฒะฐัั ARM64. MySQL ะฝะฐัััะพะตะฝ ะฑะตะท O_DIRECT ะดะปั ัะพะฒะผะตััะธะผะพััะธ.

### ะะพะถะฝะพ ะปะธ ะธัะฟะพะปัะทะพะฒะฐัั ะฝะฐ Windows?
**ะะฐ!** ะะพ ัะพะปัะบะพ ั WSL 2:
```powershell
wsl --install
# ะะฐัะตะผ ัะฐะฑะพัะฐะนัะต ะธะท WSL ัะตัะผะธะฝะฐะปะฐ
```

### ะะดะต ััะฐะฝัััั ะปะพะณะธ?
- **ะคะฐะนะปั**: `./volume/logs/` (7 ะดะฝะตะน)
- **Loki**: ัะตัะตะท Grafana (1 ะณะพะด)

### ะะฐะบ ะฝะฐัััะพะธัั SMTP?
ะะปั production ะฝะฐัััะพะนัะต ะฒ:
- ะะดะผะธะฝะบะฐ โ ะะฐัััะพะนะบะธ โ ะะพััะพะฒัะต ัะพะฑััะธั

ะะปั local/dev ะธัะฟะพะปัะทัะนัะต MailHog (ัะถะต ะฝะฐัััะพะตะฝ):
- Web UI: http://localhost:8025

## ๐ Production Checklist

ะะตัะตะด ะทะฐะฟััะบะพะผ ะฝะฐ production:

- [ ] ะกะผะตะฝะธัะต ะะกะ ะฟะฐัะพะปะธ ะฒ `.env`
- [ ] ะฃััะฐะฝะพะฒะธัะต `DEBUG=0`
- [ ] ะะฐัััะพะนัะต SSL (`SSL=free` ะดะปั Let's Encrypt)
- [ ] ะะฐัััะพะนัะต firewall (ัะพะปัะบะพ 80, 443, 22)
- [ ] ะะฐัััะพะนัะต ะฐะฒัะพะผะฐัะธัะตัะบะธะต ะฑัะบะฐะฟั
- [ ] ะะฐัััะพะนัะต ะฒะฝะตัะฝะตะต ััะฐะฝะธะปะธัะต ะฑัะบะฐะฟะพะฒ (S3, rsync)
- [ ] ะะฐัััะพะนัะต ะฐะปะตััั ะฒ Grafana
- [ ] ะัะพะฒะตัััะต ะฟัะฐะฒะฐ ะฝะฐ ะดะธัะตะบัะพัะธะธ
- [ ] ะะบะปััะธัะต ะบะพะผะฟะพะทะธัะฝัะน ะบัั ะะธััะธะบัะฐ
- [ ] ะะฐัััะพะนัะต ะผะพะฝะธัะพัะธะฝะณ ัะตัะตะท Grafana

## ๐ค ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ:

1. ะัะพะฒะตัััะต [Troubleshooting](#-troubleshooting)
2. ะัะพะฒะตัััะต [FAQ](#-faq)
3. ะะทััะธัะต ะปะพะณะธ: `docker compose logs -f`
4. ะัะพะฒะตัััะต ััะฐััั: `docker compose exec bitrix supervisorctl status`

## ๐ ะะธัะตะฝะทะธั

MIT License

## ๐ ะัะพะณะพะฒัะต ะฒะพะทะผะพะถะฝะพััะธ

**ะงัะพ ะฒะบะปััะตะฝะพ:**
- โ ะะพะปะฝัะน ะฒะตะฑ-ััะตะบ: Nginx + PHP + MySQL + Redis + Memcached
- โ ะะดะธะฝัะน Bitrix ะบะพะฝัะตะนะฝะตั ั Supervisor
- โ ะะพะฝะธัะพัะธะฝะณ: Grafana + Prometheus + Loki
- โ ะะพะณะธัะพะฒะฐะฝะธะต: 1 ะณะพะด ะฒ Loki + 7 ะดะฝะตะน ะฒ ัะฐะนะปะฐั
- โ ะะตะทะพะฟะฐัะฝะพััั: Security scanning + Rate limiting + Security headers + Fail2ban + ModSecurity
- โ ะะฒัะพะฝะฐัััะพะนะบะฐ ะฟะพะด ะถะตะปะตะทะพ
- โ ะะพัะพะฒัะต ะบะพะฝัะธะณะธ ะดะปั local/dev/test/prod
- โ ะัะพัั-ะฟะปะฐััะพัะผะตะฝะฝะพััั: Linux, macOS, Windows (WSL2)

**Production ready!** โจ
