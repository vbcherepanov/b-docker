# =============================================================================
# NGINX STATUS ENDPOINT FOR PROMETHEUS MONITORING
# =============================================================================

server {
    listen 8080;
    server_name localhost;
    
    # Use Docker DNS resolver
    resolver 127.0.0.11 valid=30s ipv6=off;
    
    # Nginx stub_status for nginx-exporter
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 172.20.0.0/16;
        allow 127.0.0.1;
        deny all;
    }
    
    # PHP-FPM status for php-fpm-exporter
    location ~ ^/(status|ping)$ {
        access_log off;
        allow 172.20.0.0/16;
        allow 127.0.0.1;
        deny all;
        
        set $backend bitrix:9000;
        fastcgi_pass $backend;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
