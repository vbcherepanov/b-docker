# ModSecurity Core Rules Set configuration file

# Basic configuration
SecRuleEngine On
SecRequestBodyAccess On
SecRule REQUEST_HEADERS:Content-Type "text/xml" \
    "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
SecRule REQUEST_HEADERS:Content-Type "application/json" \
    "id:'200001',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject

# Response body access
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Filesystem configuration
SecTmpDir /tmp/
SecDataDir /tmp/
SecUploadDir /tmp/

# Debug log
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 0

# Audit log
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/audit.log

# Misc
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127

# Rule inclusion
Include /etc/modsecurity/crs-setup.conf
Include /etc/modsecurity/rules/*.conf

# Custom rules for Bitrix
SecRule REQUEST_URI "@beginsWith /bitrix/admin/" \
    "id:1001,\
    phase:1,\
    block,\
    msg:'Bitrix admin access attempt',\
    logdata:'URI: %{REQUEST_URI}',\
    severity:2,\
    tag:'bitrix',\
    tag:'admin'"

SecRule REQUEST_URI "@contains .php" \
    "id:1002,\
    phase:1,\
    t:normalizePath,\
    block,\
    msg:'PHP file access in upload directory',\
    logdata:'URI: %{REQUEST_URI}',\
    severity:2,\
    tag:'bitrix',\
    tag:'upload'"