# Rate limiting для защиты от DDoS и брутфорс атак

# Зоны для rate limiting
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=2r/s;
limit_req_zone $binary_remote_addr zone=static:10m rate=30r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# Rate limiting применение
location ~* ^/(login|admin|auth|signin|wp-login|administrator|bitrix/admin/) {
    limit_req zone=login burst=3 nodelay;
    limit_req_status 429;
    limit_conn conn_limit_per_ip 5;
}

location ~* ^/(api|ajax)/ {
    limit_req zone=api burst=10 nodelay;
    limit_req_status 429;
}

location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|eot|svg)$ {
    limit_req zone=static burst=50 nodelay;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Общий rate limit для всех остальных запросов
location / {
    limit_req zone=general burst=5 nodelay;
    limit_req_status 429;
    limit_conn conn_limit_per_ip 10;
    limit_conn conn_limit_per_server 100;
}