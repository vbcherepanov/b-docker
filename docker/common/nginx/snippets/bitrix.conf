# ============================================================================
# BITRIX CMS - NGINX CONFIGURATION
# Полная конфигурация на основе .htaccess + оптимизации
# ============================================================================

# ============================================================================
# ОСНОВНЫЕ НАСТРОЙКИ
# ============================================================================

# Отключение отображения директорий (Options -Indexes)
autoindex off;

# Индексные файлы (DirectoryIndex)
index index.php index.html;

# Обработка 404 ошибок (ErrorDocument 404)
error_page 404 /404.php;

# ============================================================================
# URL REWRITE - Главная логика маршрутизации
# ============================================================================

# Основная обработка запросов
location / {
    # Защита директорий реализована через location ^~ блоки ниже
    # (имеют приоритет над regex locations)

    # Эквивалент Apache RewriteCond %{REQUEST_FILENAME} !-f, !-l, !-d
    # try_files автоматически проверяет существование файла/директории
    try_files $uri $uri/ @bitrix;
}

# Обработчик роутинга Bitrix (routing_index.php)
# Новый роутинг Bitrix — сначала проверяет /local/routes/
# Если роут не найден — передаёт на urlrewrite.php
location @bitrix {
    set $php_upstream bitrix:9000;
    fastcgi_pass $php_upstream;
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root/bitrix/routing_index.php;
    fastcgi_param SCRIPT_NAME /bitrix/routing_index.php;
    fastcgi_param SERVER_NAME $host;

    # Authorization для REST API
    fastcgi_param REMOTE_USER $http_authorization;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;
}

# ============================================================================
# БЕЗОПАСНОСТЬ - Запрет выполнения PHP в upload
# ============================================================================

# Запрет выполнения PHP и других исполняемых файлов в upload
# ВАЖНО: Это правило ДОЛЖНО быть ДО location ~ \.php$ чтобы иметь приоритет
location ~* /upload/.*\.(php|php3|php4|php5|php6|php7|php8|phtml|pl|asp|aspx|cgi|dll|exe|shtm|shtml|fcg|fcgi|fpl|asmx|pht|py|psp|rb|var)$ {
    types {
        text/plain text/plain php php3 php4 php5 php6 php7 php8 phtml pl asp aspx cgi dll exe ico shtm shtml fcg fcgi fpl asmx pht py psp rb var;
    }
}

# ============================================================================
# PHP ОБРАБОТКА
# ============================================================================

# Обработка PHP файлов
location ~ \.php$ {
    set $php_upstream bitrix:9000;
    fastcgi_pass $php_upstream;
    fastcgi_index index.php;

    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param SCRIPT_NAME $fastcgi_script_name;
    fastcgi_param PHP_SELF $fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT $document_root;
    fastcgi_param SERVER_NAME $host;

    # Передача HTTPS и заголовков прокси
    fastcgi_param HTTPS $https if_not_empty;
    fastcgi_param X-Forwarded-Proto $http_x_forwarded_proto;
    fastcgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
    fastcgi_param X-Forwarded-Host $host;
    fastcgi_param X-Forwarded-Port $server_port;

    # HTTP Authorization для REST API
    fastcgi_param REMOTE_USER $http_authorization;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;

    # Буферы для ответа от PHP-FPM (фикс upstream sent too big header)
    fastcgi_buffering on;
    fastcgi_buffers 32 32k;
    fastcgi_buffer_size 64k;
    fastcgi_busy_buffers_size 96k;
    fastcgi_temp_file_write_size 96k;

    # Таймауты для долгих скриптов
    fastcgi_read_timeout 300s;
    fastcgi_send_timeout 300s;

    # Скрытие версии PHP
    fastcgi_hide_header X-Powered-By;
}

# ============================================================================
# БЕЗОПАСНОСТЬ - Запрет доступа к системным файлам
# ============================================================================

# Запрет доступа к .htaccess и другим скрытым файлам Apache
location ~* /\.ht {
    deny all;
    access_log off;
    log_not_found off;
}

# Запрет доступа к VCS директориям
location ~* /\.(svn|hg|git) {
    deny all;
    access_log off;
    log_not_found off;
}

# Запрет доступа к системным директориям Bitrix
# ВАЖНО: ^~ имеет приоритет над regex locations (включая location ~ \.php$)
location ^~ /bitrix/modules {
    deny all;
    access_log off;
    log_not_found off;
}

location ^~ /bitrix/local_cache {
    deny all;
    access_log off;
    log_not_found off;
}

location ^~ /bitrix/stack_cache {
    deny all;
    access_log off;
    log_not_found off;
}

location ^~ /bitrix/managed_cache {
    deny all;
    access_log off;
    log_not_found off;
}

location ^~ /bitrix/php_interface {
    deny all;
    access_log off;
    log_not_found off;
}

# Запрет доступа к 1С обмену
location ~* ^/upload/1c_[^/]+/ {
    deny all;
    access_log off;
}

# Запрет доступа к родительским директориям
location ~* /\.\./ {
    deny all;
    access_log off;
}

# Запрет доступа к конфигурационным файлам композитного кеша
location ~* ^/bitrix/html_pages/\.config\.php {
    deny all;
    access_log off;
}

location ~* ^/bitrix/html_pages/\.enabled {
    deny all;
    access_log off;
}

# Запрет доступа к PHP файлам и конфигам в cache
# CSS/JS файлы должны быть доступны (обрабатываются ниже)
location ~* ^/bitrix/cache/.*\.php$ {
    deny all;
    access_log off;
}

# ============================================================================
# АДМИНИСТРАТИВНАЯ ПАНЕЛЬ BITRIX
# ============================================================================

# Обработка административных скриптов
location ~* /bitrix/admin.+\.php$ {
    try_files $uri @bitrixadm;
    set $php_upstream bitrix:9000;
    fastcgi_pass $php_upstream;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}

# Обработчик 404 для админки
location @bitrixadm {
    set $php_upstream bitrix:9000;
    fastcgi_pass $php_upstream;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/bitrix/admin/404.php;
}

# ============================================================================
# КЕШИРОВАНИЕ СТАТИЧЕСКИХ ФАЙЛОВ
# Эквивалент ExpiresByType из .htaccess
# ============================================================================

# Кеширование изображений (access plus 3 day)
location ~* \.(jpg|jpeg|gif|png|webp|svg|ico)$ {
    expires 3d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
    error_page 404 /404.html;
}

# Кеширование CSS и JavaScript (access plus 3 day)
location ~* \.(css|js)$ {
    expires 3d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
    error_page 404 /404.html;
}

# Кеширование шрифтов
location ~* \.(ttf|ttc|otf|eot|woff|woff2)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

# Кеширование других медиа файлов
location ~* \.(mp4|mp3|ogg|ogv|webm|flv|swf)$ {
    expires 30d;
    add_header Cache-Control "public";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

# Кеширование Bitrix CSS/JS из cache директории
location ~* ^/bitrix/cache/(css/.+\.css|js/.+\.js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    error_page 404 /404.html;
}

# Кеширование upload, bitrix/images, bitrix/tmp
location ~* ^/(upload|bitrix/images|bitrix/tmp) {
    expires 30d;
    add_header Cache-Control "public";
    add_header X-Content-Type-Options "nosniff" always;
}

# ============================================================================
# КОМПОЗИТНЫЙ КЕШ BITRIX
# ============================================================================

# Обработка композитного кеша
location ~* @.*\.html$ {
    internal;
    expires -1y;
    add_header X-Bitrix-Composite "Nginx (file)";
}

# ============================================================================
# СПЕЦИАЛЬНЫЕ ПРАВИЛА
# ============================================================================

# favicon.ico - не логировать
location = /favicon.ico {
    log_not_found off;
    access_log off;
    expires 30d;
}

# robots.txt - разрешить всем
location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
}

# 404.html - не логировать
location = /404.html {
    access_log off;
    internal;
}

# Support - не отдавать изображения напрямую
location ^~ /upload/support/not_image {
    internal;
}

# CORS для медиаплеера
# SECURITY: Access-Control-Allow-Origin: * removed
# If cross-origin media playback is needed, configure specific domains in Bitrix
location ~* ^/bitrix/components/bitrix/player/mediaplayer/player$ {
    # add_header Access-Control-Allow-Origin $http_origin;
    # add_header Access-Control-Allow-Credentials true;
}

# ============================================================================
# AMAZON S3 PROXY (для облачного хранилища)
# ============================================================================

location ^~ /upload/bx_cloud_upload/ {
    location ~ ^/upload/bx_cloud_upload/(http[s]?)\.([^/:]+)\.(s3|s3-us-west-1|s3-eu-west-1|s3-ap-southeast-1|s3-ap-northeast-1)\.amazonaws\.com/(.+)$ {
        internal;
        resolver 8.8.8.8;
        proxy_method GET;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Server $host;
        proxy_max_temp_file_size 0;
        proxy_pass $1://$2.$3.amazonaws.com/$4;
    }

    location ~* .* {
        deny all;
    }
}

# ============================================================================
# PUSH SERVER - REAL-TIME NOTIFICATIONS
# ============================================================================
# Uses Docker DNS resolver for dynamic upstream resolution
# This prevents nginx from failing if push-server is not running

# WebSocket/Long-polling for Bitrix Push&Pull
location /bitrix/sub/ {
    resolver 127.0.0.11 valid=30s ipv6=off;
    set $push_server push-server:8010;
    proxy_pass http://$push_server;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
    proxy_buffering off;
}

location /bitrix/subws/ {
    resolver 127.0.0.11 valid=30s ipv6=off;
    set $push_server push-server:8010;
    proxy_pass http://$push_server;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
    proxy_buffering off;
}

# Push server stats (internal only)
location /server-stat/ {
    resolver 127.0.0.11 valid=30s ipv6=off;
    set $push_server push-server:8010;
    proxy_pass http://$push_server;
    allow 127.0.0.1;
    allow 172.20.0.0/16;
    deny all;
}

# ============================================================================
# HEALTH CHECK
# ============================================================================

include /etc/nginx/snippets/health.conf;
