# ============================================================================
# BITRIX DOCKER ENVIRONMENT
# ============================================================================
# Скопируйте этот файл в .env и отредактируйте под ваши нужды:
#   cp .env.example .env
#
# Для автоматической настройки под ваш сервер:
#   make setup
# ============================================================================

# ============================================================================
# ОСНОВНЫЕ НАСТРОЙКИ
# ОСНОВНЫЕ НАСТРОЙКИ
# ============================================================================
COMPOSE_PROJECT_NAME=bitrix
ENVIRONMENT=local
# Режимы: local (разработка), dev (тестовый сервер), prod (production)
DEBUG=1
TZ=Europe/Moscow

# Домен сайта
DOMAIN=bitrix.local
EMAIL=admin@bitrix.local

# ============================================================================
# ПОЛЬЗОВАТЕЛЬ И ГРУППА (важно для прав доступа)
# ============================================================================
# macOS/Linux: используйте свой UID/GID (узнать: id -u и id -g)
# Windows: оставьте 1000
UID=1000
GID=1000
UGN=bitrix

# ============================================================================
# СЕТЕВЫЕ НАСТРОЙКИ
# ============================================================================
DOCKER_SUBNET=172.20.0.0/16

# Порты
HTTP_PORT=80
HTTPS_PORT=443

# ============================================================================
# SSL НАСТРОЙКИ
# ============================================================================
# Режимы SSL:
#   0    = без SSL (HTTP only)
#   self = свои сертификаты (положить в config/nginx/ssl/${DOMAIN}/)
#   free = Let's Encrypt (автоматическая генерация и обновление)
SSL=0

# Email для Let's Encrypt (обязателен при SSL=free)
LETSENCRYPT_EMAIL=admin@example.com

# ============================================================================
# PHP НАСТРОЙКИ
# ============================================================================
# Доступные версии: 7.4, 8.3, 8.4
# ВНИМАНИЕ: PHP 8.4 экспериментальная, Bitrix официально поддерживает до 8.3
PHP_VERSION=8.3
# PHP-FPM Pool настройки
# Формулы для расчёта:
#   MAX_CHILDREN = CPU_CORES * 3
#   START_SERVERS = CPU_CORES * 0.75
#   MIN_SPARE = MAX(CPU_CORES - 1, 2)
#   MAX_SPARE = CPU_CORES
PHP_FPM_PM=dynamic
PHP_FPM_MAX_CHILDREN=12
PHP_FPM_START_SERVERS=3
PHP_FPM_MIN_SPARE_SERVERS=2
PHP_FPM_MAX_SPARE_SERVERS=4
# PHP лимиты (Bitrix official: 512M memory, 1024M uploads)
PHP_MEMORY_LIMIT=512M
PHP_UPLOAD_MAX_FILESIZE=1024M
PHP_POST_MAX_SIZE=1024M
PHP_MAX_EXECUTION_TIME=300
PHP_MAX_INPUT_TIME=60
# ============================================================================
# OPCACHE (Bitrix official recommendations)
# ============================================================================
# Для local: ENABLE=0 (актуальный код без кэша)
# Для prod: ENABLE=1 (максимальная производительность)
PHP_OPCACHE_ENABLE=0
# Memory: 128 (low RAM), 256 (default), 512 (high RAM)
# Bitrix official: 471MB
PHP_OPCACHE_MEMORY=256
# Interned strings buffer (Bitrix official: 117MB, we use 64MB)
PHP_OPCACHE_INTERNED_STRINGS=64
# Max cached files (Bitrix official: 100000)
PHP_OPCACHE_MAX_FILES=100000
# Revalidate frequency (seconds)
# 0 = every request (development)
# 2 = every 2 seconds (production)
PHP_OPCACHE_REVALIDATE_FREQ=0

# # ============================================================================
 #  # MYSQL - БАЗА ДАННЫХ
 #  # ============================================================================
 #  # Выбор движка базы данных в зависимости от RAM:
 #  # ─────────────────────────────────────────────────────────────────────────────
 #  # RAM < 4GB:
 #  #   mariadb:10.11 (default) - низкое потребление памяти, совместим с Bitrix
 #  #
 #  # RAM 4-16GB:
 #  #   quay.io/bitrix24/percona-server:8.0.44-v1-rhel - BITRIX OFFICIAL
 #  #   mysql:8.0 - стандартный MySQL
 #  #
 #  # RAM > 16GB:
 #  #   quay.io/bitrix24/percona-server:8.4.7-v1-rhel - новейшая Percona
 #  #   mysql:8.4 - новейший MySQL
 #  # ─────────────────────────────────────────────────────────────────────────────
MYSQL_IMAGE=mariadb:10.11
 #  # MYSQL_IMAGE=quay.io/bitrix24/percona-server:8.0.44-v1-rhel

DB_HOST=mysql
DB_PORT=3306
DB_NAME=bitrix
DB_USERNAME=bitrix
DB_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD
DB_ROOT_PASSWORD=CHANGE_ME_GENERATE_SECURE_ROOT_PASSWORD

# MySQL настройки (автоматически оптимизируются через make setup)
# INNODB_BUFFER_POOL_SIZE = RAM * 0.5 (для выделенного сервера до 0.7)
# MAX_CONNECTIONS = CPU_CORES * 10
MYSQL_INNODB_BUFFER_POOL_SIZE=1G
MYSQL_MAX_CONNECTIONS=50
MYSQL_MEMORY_LIMIT=2G
MYSQL_MEMORY_RESERVATION=1G

# ============================================================================
# REDIS - КЭШИРОВАНИЕ
# ============================================================================
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD
REDIS_MAX_MEMORY=128mb

# ============================================================================
# MEMCACHED - ДОПОЛНИТЕЛЬНОЕ КЭШИРОВАНИЕ
# ============================================================================
MEMCACHED_HOST=memcached
MEMCACHED_PORT=11211
MEMCACHED_MEMORY_LIMIT=128
MEMCACHED_THREADS=4
MEMCACHED_CONN_LIMIT=1024

# ============================================================================
# RABBITMQ - ОЧЕРЕДИ (опционально)
# ============================================================================
RABBITMQ_HOST=amqp
RABBIT_PORT=5672
RABBIT_UI_PORT=15672
RABBIT_COOKIE=CHANGE_ME_GENERATE_WITH_openssl_rand_hex_20
RABBITMQ_DEFAULT_USER=admin
RABBITMQ_DEFAULT_PASS=CHANGE_ME_GENERATE_SECURE_PASSWORD
RABBITMQ_DEFAULT_VHOST=/

# ============================================================================
# MAILHOG - ПЕРЕХВАТ ПОЧТЫ (только для local/dev)
# ============================================================================
MAILHOG_PORT=1025
MAILHOG_WEB_PORT=8025

# ============================================================================
# PUSH SERVER - REAL-TIME УВЕДОМЛЕНИЯ
# ============================================================================
# Секретный ключ для подписи между PHP и Push Server
# Генерация: openssl rand -hex 32
PUSH_SECURITY_KEY=CHANGE_ME_GENERATE_WITH_openssl_rand_hex_32
PUSH_PUB_PORT=9010
PUSH_SUB_PORT=8010

# ============================================================================
# МОНИТОРИНГ
# ============================================================================
# Включение сервисов мониторинга
ENABLE_GRAFANA=1
ENABLE_PROMETHEUS=1
ENABLE_LOKI=1

# Порты
GRAFANA_PORT=3000
PROMETHEUS_PORT=9090

# Grafana admin
GRAFANA_ADMIN_PASSWORD=admin

# ============================================================================
# СУБДОМЕНЫ ДЛЯ СЕРВИСОВ
# ============================================================================
# При включении автоматически создаются:
# - nginx конфиг для субдомена
# - SSL сертификат (если SSL=free)
# - Basic Auth (MONITORING_USER/PASSWORD)

# Флаги включения (0 = выкл, 1 = вкл)
MAIL_CONFIG=0
RABBIT_CONFIG=0
GRAFANA_CONFIG=0
PROMETHEUS_CONFIG=0

# Кастомные имена субдоменов
# Пример: GRAFANA_SUBDOMAIN=mon -> mon.bitrix.local
MAIL_SUBDOMAIN=mail
RABBIT_SUBDOMAIN=rabbit
GRAFANA_SUBDOMAIN=grafana
PROMETHEUS_SUBDOMAIN=prometheus

# Basic Auth для субдоменов мониторинга
MONITORING_USER=admin
MONITORING_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD

# ============================================================================
# БЭКАПЫ
# ============================================================================
BACKUP_SCHEDULE_DB="0 2 * * *"
BACKUP_SCHEDULE_FILES="0 3 * * *"
BACKUP_RETENTION_DAYS=7
BACKUP_PATH=./backups

# ============================================================================
# PORTAINER AGENT (опционально)
# ============================================================================
ENABLE_PORTAINER_AGENT=0
PORTAINER_PORT=9001
PORTAINER_AGENT_SECRET=CHANGE_ME_GENERATE_SECURE_SECRET

# ============================================================================
# BITRIX
# ============================================================================
BITRIX_VM_VER=9.0.0

# ============================================================================
# NGINX (служебные)
# ============================================================================
DOLLAR=$

# ============================================================================
# DOCKER COMPOSE PROFILES
# ============================================================================
# Профили для разных окружений:
#   local      - локальная разработка (mailhog, xdebug)
#   dev        - dev сервер
#   prod       - production
#   monitoring - grafana, prometheus, loki
#   push       - push server для real-time
#   backup     - контейнер бэкапов
#   rabbitmq   - очереди сообщений
#   security   - fail2ban, modsecurity
COMPOSE_PROFILES=local
