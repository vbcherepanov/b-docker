#!/bin/bash
# ============================================================
# Security & Performance Fixes for b-docker
# Generated: 2026-01-18
# Run: chmod +x apply-security-fixes.sh && ./apply-security-fixes.sh
# ============================================================

set -euo pipefail

echo "========================================"
echo "  B-DOCKER SECURITY & PERFORMANCE FIXES"
echo "========================================"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Base directory (project root, one level up from scripts/)
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$BASE_DIR"

# Backup function
backup_file() {
    local file="$1"
    if [ -f "$file" ]; then
        cp "$file" "${file}.backup.$(date +%Y%m%d_%H%M%S)"
        echo -e "${GREEN}[BACKUP]${NC} $file"
    fi
}

echo "=== 1. FIXING .env.example ==="
if [ -f ".env.example" ]; then
    backup_file ".env.example"

    # Fix passwords in .env.example
    sed -i.bak \
        -e 's/DB_PASSWORD=bitrix123/DB_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD/' \
        -e 's/DB_ROOT_PASSWORD=root123/DB_ROOT_PASSWORD=CHANGE_ME_GENERATE_SECURE_ROOT_PASSWORD/' \
        -e 's/REDIS_PASSWORD=$/REDIS_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD/' \
        -e 's/RABBIT_COOKIE=SWQOKODSQALRPCLNMEQG/RABBIT_COOKIE=CHANGE_ME_GENERATE_WITH_openssl_rand_hex_20/' \
        -e 's/RABBITMQ_DEFAULT_PASS=admin123/RABBITMQ_DEFAULT_PASS=CHANGE_ME_GENERATE_SECURE_PASSWORD/' \
        -e 's/MONITORING_PASSWORD=changeme123/MONITORING_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD/' \
        -e 's/PORTAINER_AGENT_SECRET=myagentsecret/PORTAINER_AGENT_SECRET=CHANGE_ME_GENERATE_SECURE_SECRET/' \
        .env.example
    rm -f .env.example.bak
    echo -e "${GREEN}[FIXED]${NC} .env.example - passwords replaced with secure placeholders"
else
    echo -e "${YELLOW}[SKIP]${NC} .env.example not found (production mode)"
fi

echo ""
echo "=== 2. FIXING config/redis/redis.conf ==="
backup_file "config/redis/redis.conf"

cat > config/redis/redis.conf << 'REDIS_EOF'
# Redis configuration - SECURE VERSION
# Generated by security-fixes script

# Security - CRITICAL
bind 127.0.0.1
protected-mode yes

# Network
port 6379
timeout 0
tcp-keepalive 300
tcp-backlog 65535

# Memory - aligned with docker-compose
maxmemory 512mb
maxmemory-policy allkeys-lru
databases 1

# Disable persistence for cache (faster)
save ""

# Performance optimizations
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Logging
loglevel notice
logfile ""

# Data structures optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# Active defragmentation (Redis 4.0+)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
REDIS_EOF
echo -e "${GREEN}[FIXED]${NC} config/redis/redis.conf - security + performance"

echo ""
echo "=== 3. FIXING config/backup/backup.sh ==="
if [ -f "config/backup/backup.sh" ]; then
    backup_file "config/backup/backup.sh"

    # Replace fallback passwords with required checks
    sed -i.bak \
        -e 's/DB_PASSWORD=\${DB_PASSWORD:-bitrix123}/# Security: Require explicit password\nif [ -z "\${DB_PASSWORD:-}" ]; then echo "ERROR: DB_PASSWORD not set"; exit 1; fi\nDB_PASSWORD="\${DB_PASSWORD}"/' \
        -e 's/DB_ROOT_PASSWORD=\${DB_ROOT_PASSWORD:-root123}/if [ -z "\${DB_ROOT_PASSWORD:-}" ]; then echo "ERROR: DB_ROOT_PASSWORD not set"; exit 1; fi\nDB_ROOT_PASSWORD="\${DB_ROOT_PASSWORD}"/' \
        config/backup/backup.sh
    rm -f config/backup/backup.sh.bak
    echo -e "${GREEN}[FIXED]${NC} config/backup/backup.sh - removed fallback passwords"
else
    echo -e "${YELLOW}[SKIP]${NC} config/backup/backup.sh not found"
fi

echo ""
echo "=== 4. FIXING docker/common/scripts/backup-manager.sh ==="
if [ -f "docker/common/scripts/backup-manager.sh" ]; then
    backup_file "docker/common/scripts/backup-manager.sh"

    sed -i.bak \
        -e 's/DB_PASSWORD=\${DB_PASSWORD:-bitrix123}/# Security: Require explicit password\nif [ -z "\${DB_PASSWORD:-}" ]; then echo "ERROR: DB_PASSWORD not set"; exit 1; fi\nDB_PASSWORD="\${DB_PASSWORD}"/' \
        -e 's/DB_ROOT_PASSWORD=\${DB_ROOT_PASSWORD:-root123}/if [ -z "\${DB_ROOT_PASSWORD:-}" ]; then echo "ERROR: DB_ROOT_PASSWORD not set"; exit 1; fi\nDB_ROOT_PASSWORD="\${DB_ROOT_PASSWORD}"/' \
        docker/common/scripts/backup-manager.sh
    rm -f docker/common/scripts/backup-manager.sh.bak
    echo -e "${GREEN}[FIXED]${NC} docker/common/scripts/backup-manager.sh - removed fallback passwords"
else
    echo -e "${YELLOW}[SKIP]${NC} docker/common/scripts/backup-manager.sh not found"
fi

echo ""
echo "=== 5. FIXING docker/common/php/conf.d/opcache.ini ==="
backup_file "docker/common/php/conf.d/opcache.ini"

cat > docker/common/php/conf.d/opcache.ini << 'OPCACHE_EOF'
; OPcache configuration for Bitrix - PRODUCTION OPTIMIZED
; CRITICAL: validate_timestamps=0 for production
; Set OPCACHE_VALIDATE_TIMESTAMPS=1 in .env for development

opcache.enable=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=64
opcache.max_accelerated_files=20000
opcache.max_wasted_percentage=5

; PRODUCTION: Set to 0 for maximum performance
; Files changes require opcache_reset() or PHP-FPM restart
opcache.validate_timestamps=0
opcache.revalidate_freq=0

opcache.save_comments=1
opcache.enable_cli=0
opcache.blacklist_filename=/etc/php.d/opcache*.blacklist

; File update strategy
opcache.consistency_checks=0
opcache.force_restart_timeout=180

; JIT for PHP 8.0+ (optional, uncomment for extra 5-15% on CPU tasks)
; opcache.jit=tracing
; opcache.jit_buffer_size=256M
OPCACHE_EOF
echo -e "${GREEN}[FIXED]${NC} docker/common/php/conf.d/opcache.ini - production settings"

echo ""
echo "=== 6. FIXING docker/common/nginx/nginx.conf ==="
backup_file "docker/common/nginx/nginx.conf"

cat > docker/common/nginx/nginx.conf << 'NGINX_EOF'
user bitrix;
worker_processes auto;
worker_rlimit_nofile 65535;
pid /var/run/nginx/nginx.pid;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
}

http {

    ##
    # Security Settings
    ##
    server_tokens off;

    ##
    # Performance: File Cache
    ##
    open_file_cache max=10000 inactive=60s;
    open_file_cache_valid 120s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    ##
    # Basic Settings
    ##
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    types_hash_max_size 2048;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # Logging Settings
    ##
    log_format main_json '{'
      '"msec":"$msec", '
      '"output":"$request", '
      '"status":"$status", '
      '"request_time":"$request_time", '
      '"request_uri":"$request_uri", '
      '"request_method":"$request_method", '
      '"server_name":"$host", '
      '"remote_addr":"$remote_addr", '
      '"http_referer":"$http_referer", '
      '"http_user_agent":"$http_user_agent", '
      '"upstream_cache_status":"$upstream_cache_status"'
    '}';

    access_log /dev/stdout main_json;
    error_log  /dev/stderr warn;

    ##
    # Gzip Compression
    ##
    gzip on;
    gzip_http_version 1.0;
    gzip_comp_level 4;
    gzip_min_length 1100;
    gzip_buffers 16 8k;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml
        image/x-icon;
    gzip_static on;
    gzip_proxied expired no-cache no-store private auth;
    gzip_disable "MSIE [1-6]\.";
    gzip_vary on;

    ##
    # Client Settings
    ##
    client_max_body_size 1024M;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    ##
    # Proxy & FastCGI Timeouts
    ##
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    fastcgi_send_timeout 300s;
    fastcgi_read_timeout 300s;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    chunked_transfer_encoding on;

    ##
    # FastCGI Cache (optional - for high performance)
    ##
    # Uncomment to enable FastCGI caching
    # fastcgi_cache_path /var/cache/nginx/fastcgi
    #     levels=1:2
    #     keys_zone=BITRIX:256m
    #     inactive=1h
    #     max_size=2g
    #     use_temp_path=off;

    include /etc/nginx/conf.d/*.conf;

}
NGINX_EOF
echo -e "${GREEN}[FIXED]${NC} docker/common/nginx/nginx.conf - security + performance"

echo ""
echo "=== 7. FIXING docker-compose.bitrix.yml ==="
if [ -f "docker-compose.bitrix.yml" ]; then
    backup_file "docker-compose.bitrix.yml"

    # Fix image versions (replace :latest with specific versions)
    sed -i.bak \
        -e 's|grafana/grafana:latest|grafana/grafana:10.3.1|g' \
        -e 's|prom/prometheus:latest|prom/prometheus:v2.49.1|g' \
        -e 's|grafana/loki:latest|grafana/loki:2.9.4|g' \
        -e 's|grafana/promtail:latest|grafana/promtail:2.9.4|g' \
        docker-compose.bitrix.yml

    # Note: memcached -u root is required when container runs as root

    rm -f docker-compose.bitrix.yml.bak
    echo -e "${GREEN}[FIXED]${NC} docker-compose.bitrix.yml - image versions + security"
else
    echo -e "${YELLOW}[SKIP]${NC} docker-compose.bitrix.yml not found"
fi

echo ""
echo "=== 8. FIXING docker/common/nginx/snippets/ssl.conf ==="
if [ -d "docker/common/nginx/snippets" ]; then
backup_file "docker/common/nginx/snippets/ssl.conf"

cat > docker/common/nginx/snippets/ssl.conf << 'SSL_EOF'
# SSL Configuration - Mozilla Intermediate (2024)
# https://ssl-config.mozilla.org/

# Protocols - TLS 1.2 and 1.3 only
ssl_protocols TLSv1.2 TLSv1.3;

# Ciphers - Modern secure ciphers
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

# Let the client choose the cipher (modern approach)
ssl_prefer_server_ciphers off;

# SSL Session caching
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 1d;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;

# Diffie-Hellman parameter (generate with: openssl dhparam -out /etc/nginx/dhparam.pem 4096)
# ssl_dhparam /etc/nginx/dhparam.pem;

# Security headers
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# DNS resolver for OCSP is defined in resolver.conf (included separately)
# Do NOT add resolver here - it conflicts with resolver.conf in server blocks
SSL_EOF
echo -e "${GREEN}[FIXED]${NC} docker/common/nginx/snippets/ssl.conf - modern TLS config"
else
    echo -e "${YELLOW}[SKIP]${NC} docker/common/nginx/snippets/ not found"
fi

echo ""
echo "========================================"
echo -e "${GREEN}  ALL FIXES APPLIED SUCCESSFULLY!${NC}"
echo "========================================"
echo ""
echo "Next steps:"
echo "1. Review the changes: git diff"
echo "2. Generate secure passwords:"
echo "   openssl rand -base64 32  # For passwords"
echo "   openssl rand -hex 20     # For RABBIT_COOKIE"
echo ""
echo "3. Update your .env file with real passwords"
echo "4. Rebuild containers: docker compose build --no-cache"
echo "5. Restart: docker compose down && docker compose up -d"
echo ""
echo -e "${YELLOW}WARNING:${NC} Backup files created with .backup.* suffix"
echo ""